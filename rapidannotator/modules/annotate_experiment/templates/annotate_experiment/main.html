{% extends "annotate_experiment/base.html" %}
{% from "macros.html" import render_field %}
{% from "macros.html" import icons %}

{% block title %} {{experiment.name}} {% endblock title %}
{% block head %}
  <link rel="stylesheet" href="{{url_for('static', filename = 'css/via.css')}}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/css/ion.rangeSlider.min.css"/>


  {{ super() }}
  <style type="text/css">
    .important { color: #336699; }
    .red {
        color: red;
    }
    .hl { background: yellow; }
    
    span.hl { background: yellow; }
    * {
 	 	box-sizing: border-box;
	}
    .irs--modern .irs-from, .irs--modern .irs-to, .irs--modern .irs-single {
        font-size:15px; !important
    }
    .time-range-slider{
        margin-bottom:30px;
    }
    .time-range-control{
        width:49%;
    }
    .time-control-btn{
        width:24%;
        margin:5px 0 5px 0;
    }
    audio, video{
        width:98%;
        margin-top:10px;
    }
    .irs--modern .irs-bar, .irs--modern .irs-line{
        height: 15px;
    }
    .irs--modern .irs-handle > i:nth-child(2) {
        height: 17px;
    }
  </style>  
{% endblock head %}

{% block annotate_experiment_body %}

<!-- <div class="container">
    <h5><a>Home</a> > <a>Annotate Experiment</a></h5>
</div> -->

{%- set totalAnnotationLevels = experiment.annotation_levels | count %}

<div class="container">
    <div style="display: inline-block">
        <h3 style="display: inline"><b>{{ experiment.name }}</b></h3>
    </div>

    <div style="display: inline; margin-left: 27%; margin-right: 15%">
        <b id="prg" style="font-size: 18px;"> Progress: {{currentFileIndex}} / {{lastFile + 1}}</b>
    </div>

    <div class="pull-right" style="display: inline-block">
        <button type="button" class="undoButton btn btn-warning btn-group btn-group-inline btn-space">Undo</button>
    </div>
    <div class="pull-right" style="display:inline-block">
        <button type="button" class="doneButton btn btn-success btn-group btn-group-inline btn-space" title="if clicked cannot undo!"> 
            Done 
        </button>
    </div>

    <div class="pull-right" style="display: inline-block">
        {%- if (experiment.category == 'video') or (experiment.category == 'audio') -%}
            <button class="toggleLooping btn btn-primary btn-group btn-group-inline btn-space"
                type="button" value={{current_user.looping}}>
                {%- if current_user.looping -%}
                    {{ ('Turn off looping') }}
                {%- else -%}
                    {{ ('Turn on looping') }}
                    {%- endif -%}
            </button>
            {%- if (experiment.uploadType == 'manual') -%}
            {%- endif -%}
        {%- endif -%}
        {%- if (experiment.category == 'video') -%}
            <button class="fsMode btn btn-primary btn-group btn-group-inline btn-space"
                type="button" id="fsMode"> Fullscreen Mode</button>
        {%- endif -%}
    </div>



    <div class="progress" style="width:40%; margin-left: 20%; margin-right: 80%">
        <div class="progress-bar progress-bar-info progress-bar-striped  active" id = "progress-bar" role="progressbar" aria-valuenow="80" aria-valuemin="0" aria-valuemax="100" style="width: {{progress_width}}%">
                <div id="preview" style="color:black"> {{progress_width}}%</div>
        </div>
    </div>

    <hr class="horizontal-line">
</div>

<div class="container annotationArea">
    <div class="row">
        {%- if experiment.advancedAnnotation -%}
        {%- if experiment.category == 'image' -%}
        {{ icons() }}
          <span>
            <div class="leftsidebar_accordion_panel show">
              <ul class="region_shape">
                <li id="region_shape_none"  class="selected" onclick="select_region_shape('none')" title="No select"><svg height="20" viewbox="0 0 24 24"><use xlink:href="#icon_pointer"></use></svg></li>
                <li id="region_shape_rect" onclick="select_region_shape('rect')" title="Rectangle"><svg height="32" viewbox="0 0 32 32"><use xlink:href="#shape_rectangle"></use></svg></li>
                <li id="region_shape_circle" onclick="select_region_shape('circle')" title="Circle"><svg height="32" viewbox="0 0 32 32"><use xlink:href="#shape_circle"></use></svg></li>
                <li id="region_shape_ellipse" onclick="select_region_shape('ellipse')" title="Ellipse"><svg height="32" viewbox="0 0 32 32"><use xlink:href="#shape_ellipse"></use></svg></li>
                <li id="region_shape_polygon" onclick="select_region_shape('polygon')" title="Polygon"><svg height="32" viewbox="0 0 32 32"><use xlink:href="#shape_polygon"></use></svg></li>
                <li id="region_shape_point" onclick="select_region_shape('point')" title="Point"><svg height="32" viewbox="0 0 32 32"><use xlink:href="#shape_point"></use></svg></li>
                <li id="region_shape_polyline" onclick="select_region_shape('polyline')" title="Polyline"><svg height="32" viewbox="0 0 32 32"><use xlink:href="#shape_polyline"></use></svg></li>
                <li id="region_shape_sel_all_regions" onclick="sel_all_regions()" title="Select All Regions"> <svg height="32" viewbox="0 0 32 32"><use xlink:href="#icon_selectall"></use></svg>
                <li id="region_shape_copy_sel_regions" onclick="copy_sel_regions()" title="Copy Regions"> <svg height="32" viewbox="0 0 32 32"><use xlink:href="#icon_copy"></use></svg>
                <li id="region_shape_paste_sel_regions_in_current_image" onclick="paste_sel_regions_in_current_image()" title="Paste Regions"> <svg height="32" viewbox="0 0 32 32"><use xlink:href="#icon_paste"></use></svg>
                <li id="region_shape_del_sel_regions" onclick="del_sel_regions()"  title="Delete Region"> <svg height="32" viewbox="0 0 32 32"><use xlink:href="#icon_close"></use></svg>
              </ul>
            </div>
            <div id="message_panel" style="display:none;">
              <div id="message_panel_content" class="content"></div>
            </div>
          </span>
        {%elif experiment.category == 'audio' or experiment.category == 'video' %}
            <div style="width:40%">
                <div>
                    <input class="hidden-element time-range-slider" name="my_range" value=""/>
                </div>
                <div>
                    <input class="time-range-control" placeholder="from" id="time-control-from">
                    <input class="time-range-control" placeholder="to" id="time-control-to">
                </div>
                <div>
                    <button class="time-control-btn" id="from-forward" > &raquo; </button>
                    <button class="time-control-btn" id="from-backward"> &laquo;</button>
                    <button class="time-control-btn" id="to-backward"> &laquo; </button>
                    <button class="time-control-btn" id="to-forward"> &raquo;</button>
                </div>
                <span class='glyphicon glyphicon-info-sign my-tooltip' title="Instruction"> Please follow that structure of time [hh:mm:ss] for the inputs in case of you will modifiy them manually and step size is is in seconds</span>
                <input placeholder="time step size in seconds i.e default is (0 s)" style="width:99%" type="number" min="0" id="time-step-size">
            </div>
        {% endif %}
        {% endif %}
        <!-- the following 5 is preLoadLimit @ line 418-->
        {% for i in range(5) %}
            <div class="file col-xs-5 hidden-element" data-index={{loop.index0}} data-fileid=1>
                {%- if experiment.category == 'video' -%}
                    {%- if experiment.uploadType == 'NOTviaSpreadsheet' -%}
                        <a href="" target="_blank">Click here</a>
                    {%- else -%}
                    	<div class="glass">
	                        <video class="clip" id= "clip-{{loop.index0}}" width="400" controls>
	                            <source src="" type="video/mp4">
	                            Your browser does not support HTML5 video.
	                        </video>
	                    </div>
                        <br>
                        {%- if experiment.uploadType == 'fromConcordance' -%}
                            <a href="" id="edgeLink" target="_blank" style="margin-left:30%">See more context in Edge</a>
                        {%- else -%}
                            <a href="##" id="sourceLink" target="_blank" style="margin-left:30%">Source Link</a>
                        {%- endif -%}
                    {%- endif -%}
                {%- elif experiment.category == 'audio' -%}
                    {%- if experiment.uploadType == 'NOTviaSpreadsheet' -%}
                        <a href="" target="_blank">Click here</a>
                    {%- else -%}
                    <audio class="clip" width="400" controls>
                        <source src="" type="audio/wav">
                        Your browser does not support HTML5 audio.
                    </audio>
                    <a href="" id="sourceLink" target="_blank" style="margin-left:30%">Source Link</a>
                    {%- endif -%}
                {%- elif experiment.category == 'image' -%}
                <div style="width=400px; height:450px;">
                  <div id="image_panel" class="display_area_content">
                    <img class="annotationWindow" src="" alt="" id="region-image-{{loop.index0}}"> 
                    <canvas id="region-canvas-{{loop.index0}}" width="350" height="420" tabindex="1">Sorry, your browser does not support HTML5 Canvas functionality which is required for this application.</canvas>
                  </div>
                </div>
                {%- elif experiment.category == 'text' -%}
                    <pre>
                    </pre>
                {%- endif -%}

                <div class="caption hidden-element">
                    <h4></h4>
                </div>

                <div class="fileComment hidden-element">
                    <h4></h4>
                </div>

                <div class="targetCaption hidden-element">
                    <h4></h4>
                </div>

            </div>
        {% endfor %}
        <div class="annotationLevelArea">
	        {% for level in experiment.annotation_levels | sort(attribute='id')%}
	            <div class="col-xs-7 annotationLevel hidden-element" data-index="{{loop.index}}" data-levelid="{{level.id}}" data-multichoice="{{level.multichoice}}" data-labels_others="{{level.labels_others}}">
	                {%- set levelIndex = loop.index %}
	                {%- if level.instruction != "" -%}
	                    <div class="alert alert-info alert-dismissible">
	                        <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
	                        <span class='glyphicon glyphicon-info-sign my-tooltip' title="Instruction"></span>
	                        &nbsp;{{level.instruction}}
	                    </div>
	                {%- endif -%}
	                
	                <h3 class="labelName">
	                    <b>{{level.name}}</b>
	                </h3>
	                        
	                <p>
	                    {{level.description}}
	                </p>

	                <h4><b>
	                    {{ ('Key Bindings') }}
	                </b></h4>

	                <ul class="labelKeyBindings">
	                    {% for label in level.labels %}
	                    <li data-key="{{label.key_binding}}" data-labelid="{{label.id}}">
	                        <p> {{keyBindingDict[levelIndex][label.id]}} : {{label.name}} <input data-labelid="{{label.id}}" hidden value="" class="label_other inputLevel-{{level.id}}"> </p>
	                    </li>
	                    {% endfor %}
	                </ul>

	                {% for label in level.labels %}
	                <button type="button" class="labelButton btn btn-secondary btn-group btn-group-inline labelLevel-{{level.id}}
	                    btn-space btn-space-top" data-labelid="{{label.id}}">
	                    {{ label.name }}
	                </button>
	                {% endfor %}

	            </div>
	        {% endfor %}
    	</div>
        <div class="col-xs-7 flex align-items-xxl-center" style="padding-top:10px;">
            <button type="button" class="btn btn-success btn-group btn-group-inline col-xs-3 nextButton" style="margin:auto;">
            Next
            </button>
        </div>
    </div>

    <div class="fileCaption">
        <h4></h4>
    </div><br>

    <div class="fileComments">
            <form method="POST" id="commentsForm" name="commentsForm">
                <b>Comments:</b> <br><br>
                <textarea rows = "1" cols = "100" name = "commentsData" id="commentsData"></textarea>
            </form>
    </div><br>

    <div class="fileTargetCaption">
        {%- if experiment.displayTargetCaption == 1 -%}
            <form method="POST" id="targetCaptionForm" name="targetCaptionForm">
                <b>Target Caption:</b> <br><br>
                <textarea rows = "5" cols = "100" name = "targetCaptionData" id="targetCaptionData"></textarea>
            </form>
        {%- endif -%}
    </div><br>
</div>

<div class="content hidden-element" style="position: fixed; bottom: 0; background: rgba(0, 0, 0, 0.5); color: #f1f1f1; width: 100%; padding: 10px;">
    <button id="exitFsMode" style="width: 120px; font-size: 12px; padding: 10px; border: none;background: #000; color: #fff; cursor: pointer;"> Exit FullScreen </button>
</div>

<div class="container hidden-element thanksNote">
    {%- if (lastFile + 1 == 0) or (isExpowner == 1) -%}
        <h3> No files to annotate. Thanks </h3>
    {%- else -%}
        <div class="alert alert-success hidden-element notify" id="notify" style="width:35%">
            <strong>Success!</strong> Notification has been sent !
        </div>
        <h3>No more files to annotate. Thanks</h3>
        <br>
        <button type="button" class="btn btn-warning btn-group btn-group-inline btn-space send_notification" title="click here"> 
            <span class="glyphicon glyphicon-envelope"></span>
            <b id="msg2"> Send Notification to Experimenter</b>
        </button>
    {%- endif -%}
</div>

{%- if labelWarning == 1 -%}
    <div class="alert alert-danger alert-dismissible labelWarning" style="width: 38%; position: fixed; z-index: 1; margin-left: 60%; margin-top: 2%">
        <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
        <strong>Warning!</strong> Labels have been changed! <b> Either Continue or Start Again!</b>
    </div>
{%- endif -%}
<div class="alert alert-danger alert-dismissible labelWarning hidden-element" style="width: 35%; position: fixed; z-index: 1; margin-left: 60%; margin-top: 2%">
    <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
    <strong>Warning!</strong> Labels have been changed! <b>Please refresh the screen.</b>
</div>

<div class="container">
    <div class="row">
        <div class="alert alert-danger alert-dismissible completeExp hidden-element col-md-6" style="width: 40%; z-index: 1; margin-left: 1%; margin-top: 2%">
            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
            <strong>Voila!</strong> Annotation Process is completed! <b>You can now view the results.</b>
        </div>
    </div>
</div>


<script src="{{url_for('static', filename = 'js/via.js')}}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/js/ion.rangeSlider.min.js"></script>

<script type="text/javascript">
    $(window).on('load', function() {

        var undoButton = $('.undoButton');
        var doneButton = $('.doneButton');
        var nextButton = $('.nextButton');

        var file = $('.file');
        loopingButton = $('.toggleLooping');

        loopingButton.on('click', function() {
            var url = "{{ url_for('annotate_experiment._toggleLooping')}}";
            var data = {};
            var looping = loopingButton.val();
            if ("{{ experiment.category }}" == "audio" || "{{ experiment.category }}" == "video")
                if (looping == "False")
                    media.play();
            $.getJSON(url, data, function(response) {
                var newText = "";
                var clip = file.find('.clip');
                if(looping == "True") {
                    newText = "Turn on looping";
                    loopingButton.val("False");
                    clip.removeAttr('loop');
                } else {
                    newText = "Turn off looping";
                    loopingButton.val("True");
                    clip.attr('loop','loop');
                }
                loopingButton.text(newText);
            });

        });

        $("#exitFsMode").hover(function(){
            $(this).css("background-color", "#ddd");
            $(this).css("color", "black");
            }, function(){
            $(this).css("background-color", "#000");
            $(this).css("color", "#fff");
        });

        function openFullscreen() {
          var elem = document.getElementById("clip");
          if (elem.requestFullscreen) {
            elem.requestFullscreen();
          } else if (elem.mozRequestFullScreen) { /* Firefox */
            elem.mozRequestFullScreen();
          } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari & Opera */
            elem.webkitRequestFullscreen();
          } else if (elem.msRequestFullscreen) { /* IE/Edge */
            elem.msRequestFullscreen();
          }
        }

        function closeFullscreen() {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
        }

        var fsModeButton = $('.fsMode');
        var fsModeVal = 0;

        fsModeButton.on('click', function() {

        	var annotationArea = $('.glass');
        	annotationArea.css('min-width', '100%');

        	var file = $('.file');
        	var myVideo = file.find('.clip');
            openFullscreen();

            myVideo.css('position', 'fixed');
            myVideo.css('left', 0);
            myVideo.css('right', 0);
            myVideo.css('bottom', 0);
            myVideo.css('object-fit', 'cover');
            myVideo.css('width', '100%');
            myVideo.css('height', '100%');
            myVideo.css('display', "block");

            var annotationLevelArea = $('.annotationLevelArea');
            annotationLevelArea.addClass('hidden-element');

            var fileCaptionArea = $('.fileCaption');
            fileCaptionArea.addClass('hidden-element');

            var fileTargetCaptionArea = $('.fileTargetCaption');
            fileTargetCaptionArea.addClass('hidden-element');

            var fileCommentsArea = $('.fileComments');
            fileCommentsArea.addClass('hidden-element');

            var exitFsModeButton = $('.content');
            exitFsModeButton.removeClass('hidden-element');

            fsModeVal = 1;
            toggleFullScreen();

        });

        var exitFsModeButton = $('#exitFsMode');
        exitFsModeButton.on('click', function() {
        	var file = $('.file'); 
            var myVideo = file.find('.clip');
            myVideo.removeAttr("style");
            myVideo.css('position', '');
            myVideo.css('right', '');
            myVideo.css('bottom', '');
            myVideo.css('top', '');
            myVideo.css('min-width', '');
            myVideo.css('min-height', '');
            myVideo.css('display', "");
            myVideo.css('object-fit', '');

            var annotationLevelArea = $('.annotationLevelArea');
            annotationLevelArea.removeClass('hidden-element');

            var fileCaptionArea = $('.fileCaption');
            fileCaptionArea.removeClass('hidden-element');

            var fileTargetCaptionArea = $('.fileTargetCaption');
            fileTargetCaptionArea.removeClass('hidden-element');

            var fileCommentsArea = $('.fileComments');
            fileCommentsArea.removeClass('hidden-element');

            var exitFsModeButton = $('.content');
            exitFsModeButton.addClass('hidden-element');

            fsModeVal = 0;
            closeFullscreen();
        });

        

        /*level indexing is 1 based*/
        var last_previous = 0   // Used for Undoing the Last annotation 
        var currentLevel = 1;
        var labelButton = $('.labelButton');
        var selectedLabel = -1;
        var preLoadLimit = 5;
        var currentLoadedFile = 0; // index of the div currently displayed
        var preLoadedTill = 0;
        var space_pressed = 0;
        var annotations = {};
        var annotationsOrder = {};
        var already_submitted = {};
        var progress_num = 0;
        var totalAnnotationLevels = {{ totalAnnotationLevels }};
        var keyBindingDict = {{keyBindingDict | safe}};
        var skipLevelDict = {{skipLevelDict | safe}}
        currentFileIndex = {{ currentFileIndex }};
        ////////////////////////////////////////////////////////////////////////////
        // Rapid annotator annotation level metadata
        // * VIA integrated [images] (e.g. Boundy boxes)
        // * Audio/Video Slider 
        // * Text Highlighting
        // JSON Object holds the places of the current file selected
        // If type is image it is an array of shapes as value and key is the level number
        // else if it is a text, the value is the start and end indices
        // else if it is a video or an audio it holds
        // the level as key and value is {"start":startTime , "end":endTime}
        // where startTime, endTime are the selected on the slider
        var currentFileCoordinates = {}
        ////////////////////////////////////////////////////////////////////////////
        // [RAVAs]: Rapid Annotator Text highlighting 
        // Variables for text highlighting for text selection
        var startTextIndex = 0;
        var endTextIndex = 0;
        var selectedText = "";

        ////////////////////////////////////////////////////////////////////////////
        // [RAVAs]: Rapid Annotator Video Audio slider
        // Variables for Audio/Video media time range selection
        var startTime, endTime , timerEntryCount= 0;
        var media, sliderTimer, mediaEndedTimer;
        var fromInput = $("#time-control-from" );
        var toInput = $("#time-control-to" );
        var rangeSlider =  $(".time-range-slider");
        rangeSlider.ionRangeSlider({type: "double",skin: "modern", "from":0, "to":0, "min":0, max:0});
        var mediaFileIndex = 0;
        var mediaSrc = ""
        const loopingDelay = 500 // in ms
        const maxLoadingTime = 40;
        const retySliderLoadDelay = 200;
        
        if ("{{ experiment.category }}" == "image")
            _ra_via_init(preLoadLimit);
        else if ("{{ experiment.category }}" == "audio" || "{{ experiment.category }}" == "video")
            restartTimeSlider(currentLoadedFile);
        
        if(currentFileIndex <= {{lastFile}}) {
            doneButton.addClass('hidden-element');
        }
        
        // for text highlighting
        function textHighlightingRestart(){
            if("{{experiment.displayTargetCaption}}"){
                if ("{{ experiment.uploadType }}" !== "fromConcordance" 
                && "{{ experiment.category }}" === "text")
                    thisRespondHightlightText(".file[data-index='" + currentLoadedFile + "'] pre");
                else if ("{{ experiment.category }}" === "text")
                    thisRespondHightlightText(".fileCaption h4");
            }
        }
        // UI controllers for audio/video experiment
        $("#from-forward").on("click", function(){updateTimeInput("from", 1)});
        $("#from-backward").on("click", function(){updateTimeInput("from", -1)});
        $("#to-forward").on("click", function(){updateTimeInput("to", 1)});
        $("#to-backward").on("click", function(){updateTimeInput("to", -1)});

        function updateTimeInput(name, sign){
            var stepInputValue = +$("#time-step-size").val();
            var step = isNaN(stepInputValue)? 1 : stepInputValue;
            var element = $(`#time-control-${name}`);
            var oldValue = element.val();
            var splitted = oldValue.split(":").map(e => +e);
            var h2s = splitted[0]*3600 // hours to seconds
            var m2s = splitted[1]*60 // minutes to seconds
            var s2s = splitted[2] // string seconds to number seconds
            oldValue = 0;
            if (!isNaN(h2s))
                oldValue += h2s;
            if (!isNaN(m2s))
                oldValue += m2s;
            if (!isNaN(s2s))
                oldValue += s2s;
            
            var newValue = oldValue + (sign*step);
            if (name == "from" && endTime < newValue){
                return
            }
            else if (name == "to" && startTime > newValue){
                return
            }
            if (newValue < 0) newValue = 0;
            if (name == "to" && newValue > media.duration) newValue = media.duration;
            var myRange = $(".time-range-slider").data("ionRangeSlider");
            myRange.update({
                [name]: newValue
            })
            onChangeSliderHandler({to:myRange.old_to, from:myRange.old_from});
            element.val(hhmmsss_prettify(newValue));
            //updateSlider();
        }
        // [RAVAs] Restarting the slider based on the current file times
        function restartTimeSlider(fileIndex){
            mediaFileIndex = fileIndex 
            timerEntryCount = 0;
            if ("{{ experiment.category }}" == "video" || "{{ experiment.category }}" == "audio") {
                sliderTimer = setTimeout(initSlider, retySliderLoadDelay);
            }
        }
        function replayVideo(){
            media.pause();
            var looping = loopingButton.val();
            if (looping == "True")
                setTimeout(()=>{media.currentTime = startTime; media.play();},loopingDelay)
        }
        // [RAVAs] Setting up the slider 
        function initSlider(){
            timerEntryCount += 1;
            if ("{{ experiment.category }}" == "video") 
                media = $(".file[data-index='" + mediaFileIndex + "'] video" )[0];
            else  
                media = $(".file[data-index='" + mediaFileIndex + "'] audio" )[0];
            if (!isNaN(media.duration)){
                mediaSrc = media.src;
                updateSlider(media);    
                media.addEventListener("timeupdate", function(){
                    if(media.currentTime >= endTime){
                        replayVideo();
                    }
                }, false);                
                clearTimeout(sliderTimer);
                media.addEventListener('ended', replayVideo, false);
            }
            else if(timerEntryCount < maxLoadingTime){
                clearTimeout(sliderTimer);
                sliderTimer = setTimeout(initSlider, retySliderLoadDelay);
            }
        }
        
        // [RAVAs] Updating the slider
        function updateSlider(media) {
            var myRange = $(".time-range-slider").data("ionRangeSlider");
            if (myRange){
                myRange.destroy();
            }            
            rangeSlider.ionRangeSlider({
                type: "double",
                skin: "modern",
                min: 0.0,
                max: media.duration,
                max_interval: media.duration,
                step: 0.001,
                from: 0.0,
                to: media.duration,
                drag_interval: true,
                grid: false,
                prettify: hhmmsss_prettify,
                onChange: onChangeSliderHandler
            });
            myRange =  $(".time-range-slider").data("ionRangeSlider");
            myRange.update({
                from:0.0,
                to: media.duration,
            })
            startTime = 0.0;
            endTime = media.duration;
            fromInput.val(hhmmsss_prettify(0.0));
            toInput.val(hhmmsss_prettify(media.duration));
        }
        function onChangeSliderHandler(data) {
            if (!isNaN(media.duration)){
                media.currentTime = data.from;
                startTime = data.from;
                endTime = data.to;
                fromInput.val(hhmmsss_prettify(data.from));
                toInput.val(hhmmsss_prettify(data.to));
                media.play();
            }
        }
        // [RAVAs] Utility for time representation on the slider
        function hhmmsss_prettify (n) {
            var time = parseFloat(n) * 1000.0;
            return new Date(time).toISOString().substr(11, 11)
        }
        ////////////////////////////////////////////////////////////////////////////
        
        // Text selection/highlighting 
        function thisRespondHightlightText(thisDiv){
            if ($(thisDiv).attr('listener')) return;
            $(thisDiv).attr('listener', 'true');
            $(thisDiv).on("mouseup", function () {
                selectedText = getSelectionText();
                var replacement = $('<span></span>').attr({'class':'hl'}).html(selectedText);
                var replacementHtml = $('<div>').append(replacement.clone()).remove().html();
                var text = $(this).text().replace(selectedText, replacementHtml);
                $(this).html(text);
                $("#targetCaptionData").val(selectedText);
            });
            $(thisDiv).mouseup();
        }
        function obtainSelectionCoords(start, end){
            startTextIndex = start;
            endTextIndex = end;
            if (startTextIndex > endTextIndex){
                var temp = startTextIndex;
                startTextIndex = endTextIndex;
                endTextIndex = temp;
            }
        }
        function getSelectionText() {
            var text = "";
            if (window.getSelection) {
                text = window.getSelection().toString();
                var start = window.getSelection().anchorOffset
                var end = window.getSelection().focusOffset
                obtainSelectionCoords(start, end)
                if (start == end && text.length>0 || Math.abs(start-end)==1 && text.length>1)
                    text = ""
            } else if (document.selection && document.selection.type != "Control") {
                text = document.selection.createRange().text;
                var start = document.selection().anchorOffset
                var end = document.selection().focusOffset
                obtainSelectionCoords(start, end)
                if (start == end && text.length>0 || Math.abs(start-end)==1 && text.length>1)
                    text = ""
            }
            return text;
        }

        if(currentFileIndex > {{lastFile}}){
            if({{is_done}} == 1){
                displayEnd();
                return;
            }
            if({{is_done}} == 0){
                currentFileIndex= currentFileIndex - 1;
                last_previous = 1;
                $('.annotationArea').addClass('hidden-element');
                $('.thanksNote').removeClass('hidden-element');
            }
        }



        function preLoadFiles() {
            var excessFiles = (preLoadedTill - currentLoadedFile + preLoadLimit) % preLoadLimit;
            while((excessFiles < (preLoadLimit - 1))) {
                // index where this file should be loaded
                var divIndex = (currentLoadedFile + excessFiles + 1) % preLoadLimit;
                var newFileIndex = excessFiles + currentFileIndex + 1;
                preLoadedTill = (preLoadedTill + 1) % preLoadLimit;
                excessFiles = (preLoadedTill - currentLoadedFile + preLoadLimit) % preLoadLimit;
                /*
                    first check if the file number is valid
                    then make the api call
                */
                if( newFileIndex <= {{ lastFile }} ) newFile(divIndex, newFileIndex, false);
            }
        }

        newFile(0, currentFileIndex, true);
        preLoadFiles();

        /*show only first level*/
        $(".annotationLevel[data-index=1]").removeClass('hidden-element');

        labelButton.on('click', function() {
            updateSelectedLabel($(this));
            if("{{experiment.displayTargetCaption}}" == "True"){
                var targetCaption = $("#targetCaptionData").val();
                var currentFileId = $(".file[data-index='" + currentLoadedFile + "']").data('fileid');
                save_targetCaption(currentFileId, targetCaption);

                var commentData = $("#commentsData").val();
                save_comment(currentFileId, commentData);
            }
        });
        
        

        $(document).keyup(function(event) {
            if(event.target.nodeName == "TEXTAREA" || event.target.nodeName == "INPUT" ){
                return;
            }
            var x = event.charCode || event.keyCode;
            var y = String.fromCharCode(x).toLowerCase();
            var currentLevelBody = $(".annotationLevel[data-index='" + currentLevel +"']");
            var levelId = currentLevelBody.data("levelid");
            
            if( "{{ experiment.category }}" === "video" || "{{ experiment.category }}" === "audio"){
                var tp = $(".file[data-index='" + currentLoadedFile + "']");
                tp = tp.find(".clip")[0];
                if(tp.readyState == 3 || tp.readyState == 4 || tp.readyState == 2){
                    if(!already_submitted[levelId]){
                        annotationProcess(y);
                    }
                }
            }
            else{
                if(!already_submitted[levelId]){
                    annotationProcess(y);
                }
            }
            /* undo feature */
            if(event.ctrlKey && y == 'z') {
                undoProcess();
            }

            if(x == 32){
                if(space_pressed == 0){
                    stopThisClip(currentLoadedFile);
                    space_pressed = (space_pressed + 1)%2;
                }
                else{
                    playThisClip(currentLoadedFile);
                    space_pressed = (space_pressed + 1)%2;
                }
            }
            event.stopImmediatePropagation();
            event.preventDefault();

        });


        function annotationProcess(y){
            /*for the dict in current index check if the key is there*/
            $.each( keyBindingDict[currentLevel], function( key, value ) {
                if( y == value ) {
                    if("{{experiment.displayTargetCaption}}" == "True"){
                        var targetCaption = $("#targetCaptionData").val();
                        var currentFileId = $(".file[data-index='" + currentLoadedFile + "']").data('fileid');
                        save_targetCaption(currentFileId, targetCaption);

                        var commentData = $("#commentsData").val();
                        save_comment(currentFileId, commentData);
                    }
                    selectedLabelButton = $(`.labelButton[data-labelid='${key}']`);
                    updateSelectedLabel(selectedLabelButton);
                }
            });
        }
        $("#time-control-from").keyup(function(event) {
         updateTimeInput("from",0);
        });
        $("#time-control-to").keyup(function(event) {
         updateTimeInput("to",0);
        });
        function updateSelectedLabel(labelButton){
            var currentLevelBody = $(".annotationLevel[data-index='" + currentLevel +"']");
            var multichoice = currentLevelBody.data("multichoice"); // Used for multichoice labels for the current level
            var labels_others_enabled = currentLevelBody.data("labels_others") === "True";
            levelId = currentLevelBody.data("levelid");
            selectedLabel = labelButton.data("labelid");
            if (annotations==null||annotations==undefined) annotations = {};
            if (multichoice == "True"){
                labelButton.toggleClass('btn-secondary');
                labelButton.toggleClass('btn-primary');
                textField = $(`input[data-labelid='${selectedLabel}']`);
                if (!textField.is(":visible")){
                    // display the text-field next to the label in case of enabling it on the experiment settings
                    if (labels_others_enabled)
                        textField.show();
                    if (annotations[levelId] == null){
                        annotations[levelId] = {}
                        annotations[levelId][selectedLabel] = textField.val();
                        annotationsOrder[levelId] = [selectedLabel];
                    }
                    else{
                        annotations[levelId][selectedLabel] = textField.val();
                        annotationsOrder[levelId].push(selectedLabel)
                    }
                }
                else {
                    textField.hide();
                    textField.val("");
                    delete annotations[levelId][selectedLabel];
                    const index = annotationsOrder[levelId].indexOf(selectedLabel);
                    if (index > -1) 
                        annotationsOrder[levelId].splice(index, 1);
                }
            }
            else {
                currentLevelBody = $(".annotationLevel[data-index='" + currentLevel +"']");
                levelId = currentLevelBody.data("levelid");
                $(`.labelLevel-${levelId}`).removeClass('btn-primary');
                textField = $(`input[data-labelid='${selectedLabel}']`);
                visible = textField.is(":visible");
                $(`.inputLevel-${levelId}`).hide();
                selectedLabel = labelButton.data("labelid");
                if (!visible){
                    labelButton.addClass('btn-primary');
                    labelButton.removeClass('btn-secondary');
                    // display the text-field next to the label in case of enabling it on the experiment settings
                    if (labels_others_enabled)
                        textField.show();
                    selectedLabel = labelButton.data("labelid");
                    annotations[levelId] = {}
                    annotations[levelId][selectedLabel] = textField.val();
                    annotationsOrder[levelId] = [selectedLabel];
                }
                else {
                    labelButton.removeClass('btn-primary');
                    labelButton.addClass('btn-secondary');
                    textField.hide();
                    textField.val("");
                    delete annotations[levelId][selectedLabel];
                    annotationsOrder[levelId] = [];
                }
            }
            return
        }


        function previousLevel() {
            if(last_previous == 1){
                currentFileIndex = currentFileIndex + 1;
                $('.annotationArea').removeClass('hidden-element');
                $('.thanksNote').addClass('hidden-element');
                doneButton.addClass('hidden-element');
            }
            if (currentLevel == 1) {
                loadPreviousFile(last_previous);
        
            } else {
                currentLevelBody = $(".annotationLevel[data-index='" + currentLevel +"']");
                currentLevelBody.addClass('hidden-element');
                currentLevel = currentLevel - 1;
                currentLevelBody = $(".annotationLevel[data-index='" + currentLevel +"']");
                currentLevelBody.removeClass('hidden-element');

                var currentLevelBody = $(".annotationLevel[data-index='" + currentLevel +"']");
                var levelId = currentLevelBody.data("levelid");
                already_submitted[levelId] = 0;
            }
            if(last_previous == 1){
                last_previous = 0;
            }
        }

        function nextLevelHandler(){
            currentLevelBody = $(".annotationLevel[data-index='" + currentLevel +"']");
            levelId = currentLevelBody.data("levelid");
            if ("{{ experiment.category }}" === "video" || "{{ experiment.category }}" === "audio") {
                currentFileCoordinates[levelId] = {"start":startTime, "end":endTime}
            }
            else if ("{{ experiment.category }}" === "image") {
                currentFileCoordinates[levelId] = _ra_regions.map(e=>e.shape_attributes)
            }
            else {
                currentFileCoordinates[levelId] = {"start":startTextIndex, "end":endTextIndex}
            }
            _ra_regions = [];
            _via_canvas_regions = [];
            var excessFiles = (preLoadedTill - currentLoadedFile + preLoadLimit) % preLoadLimit;
            var divIndex = (currentLoadedFile + excessFiles + 1) % preLoadLimit;
            if ("{{ experiment.category }}" == "image") {
                _ra_via_update(divIndex);
                _via_clear_reg_canvas();
            }
            already_submitted[levelId] = 1;
            multichoice = currentLevelBody.data("multichoice") == "True";
            currentLevelBody.addClass('hidden-element');
            label = selectedLabel;
            if (annotations[levelId]){
                labels_ids = Object.keys(annotations[levelId]);
                labels_ids.forEach(id=>{
                    annotations[levelId][id] = $(`input.label_other[data-labelid=${id}]`).val()
                })
            }
            if (currentLevel == totalAnnotationLevels) {
                fileAnnotationCompleted();
            }
            else if(!multichoice && skipLevelDict[levelId] &&skipLevelDict[levelId][label] == 1 ){
                currentLevel = totalAnnotationLevels;
                fileAnnotationCompleted();
            }
            updateLevelBody();
        }

        function updateLevelBody(){
            currentLevel = (currentLevel % totalAnnotationLevels) + 1;
            currentLevelBody = $(".annotationLevel[data-index='" + currentLevel +"']");
            currentLevelBody.removeClass('hidden-element');
        }

        function undoProcess(){
            undoButton.attr("disabled", "disabled");
            $('.toggleLooping').removeClass('hidden-element');
            if(last_previous == 1){
                progress_num = currentFileIndex;
            }
            else{
                if(currentFileIndex - 1 >= 0){
                    if(currentLevel == 1){
                        progress_num = currentFileIndex - 1;
                    }
                    else{
                        progress_num = currentFileIndex;
                    }
                }
            }
            progress_value = 'Progress: ' + progress_num.toString() + ' / ' + ({{lastFile}} + 1).toString()
            $("#prg").text(progress_value);                                                
            var prog_width = (progress_num/({{lastFile}} + 1))*100
            prog_width = prog_width.toFixed(2)
            $("#progress-bar").width(prog_width.toString() + '%');
            $('#preview').text(prog_width.toString() + '%');
            undoAnnotation();
            window.setTimeout(function() {
                undoButton.removeAttr("disabled");
            }, [1200]);
        }

        undoButton.on('click', function() {
            undoProcess();
        });

        nextButton.on('click', nextLevelHandler);

        doneButton.on('click', function(){
            
            if (confirm("Press OK to Submit Annotations! Once you have submitted the results, no undo operation can be performed.")){

                // alert("Once clicked you cannot perform undo operation !")
                doneButton.attr("disabled", "disabled");
                
                displayEnd();
                currentLevel = -1;
                currentFileIndex = -1;
                
                if( "{{ experiment.category }}" === "video" || "{{ experiment.category }}" === "audio") {
                    if( "{{ experiment.uploadType }}" === "manual" ) {
                    }
                        var f = $(".file[data-index='" + currentLoadedFile + "']");
                        f.find(".clip")[0].pause();
                }

                window.setTimeout(function() {
                    doneButton.removeAttr("disabled");
                }, [500]);
            }
            else{

            }
        });

        function undoAnnotation() {
            previousLevel();
        }

        function displayEnd() {
            var data = {
                'experimentId' :  "{{experiment.id}}",
            };
            $.ajax({
                url: "{{ url_for('annotate_experiment.checkStatus')}}",
                type: 'POST',
                data: data,
            });
            $('.annotationArea').addClass('hidden-element');
            $('.thanksNote').removeClass('hidden-element');
            undoButton.addClass('hidden-element');
            doneButton.addClass('hidden-element');
            $('.toggleLooping').addClass('hidden-element');
            fsModeButton.addClass('hidden-element');
            $('.completeExp').removeClass('hidden-element');
        }

        function loadPreviousFile(load_previous) {
            annotations = {};
            annotationsOrder = {};
            var currentFileId = $(".file[data-index='" + currentLoadedFile + "']").data('fileid');
            // console.log(load_previous, currentFileId);
            var data = {
                'lp': load_previous,
                'fileId' :          currentFileId,
                'experimentId' :    "{{experiment.id}}",
            };
            $.ajax({
                url: "{{ url_for('annotate_experiment.deleteAnnotation')}}",
                type: "DELETE",
                data : data,
            });

            if( "{{ experiment.category }}" === "video" || "{{ experiment.category }}" === "audio") {
                stopThisClip(currentLoadedFile);
            }
            if(currentFileIndex == 0) {
                /* do something if required */
            } else {

                currentFileIndex -= 1;
                var data = {
                    'currentFileIndex' :    currentFileIndex,
                    'experimentId' :        "{{experiment.id}}",
                };

                $.ajax({
                    url: "{{ url_for('annotate_experiment.updateCurrentFileIndex')}}",
                    type: "PUT",
                    data : data,
                    success: function(response) {
                        $(".file[data-index='" + currentLoadedFile + "']").addClass('hidden-element');
                        currentLoadedFile = 0;
                        preLoadedTill = 0;
                        newFile(0, currentFileIndex, true);
                        preLoadFiles();
                    }
                });
            }
        }

        function resetButtonsAndLabels(){
            // reset buttons and labels 
            $('.labelButton').removeClass('btn-primary');
            $('.labelButton').addClass('btn-secondary');
            $('input.label_other').hide();
            $('input.label_other').val("");
        }

        function fileAnnotationCompleted() {
            var url = "{{ url_for('annotate_experiment._addAnnotationInfo')}}";
            var currentFileId = $(".file[data-index='" + currentLoadedFile + "']").data('fileid');
            const comment = $("#commentsData").val();
            function* entries(obj) {
                for (let key in obj)
                    yield [key, obj[key]];
            }
            var data = {
                'fileId' :          currentFileId,
                'annotations' :     annotations, 
                'annotationsOrder': annotationsOrder,
                'labelCount' :     {{labelCount}},
                'userId'    : "{{userId}}",
                'hasToIncreaseCurrent': 1,
                'comment': comment,
                'coordinates': currentFileCoordinates,
            };

            data = JSON.stringify(data);
            resetButtonsAndLabels();
            $.getJSON(url , data, function(response) {
                if(response.success) {
                    annotations = {};
                    annotationsOrder = {};
                    already_submitted = {};
                    updateProgressbar();
                }
                else{
                    $('.labelWarning').removeClass('hidden-element');
                }
            });
            var excessFiles = (preLoadedTill - currentLoadedFile + preLoadLimit) % preLoadLimit;
            var divIndex = (currentLoadedFile + excessFiles + 1) % preLoadLimit;
            if( "{{ experiment.category }}" === "image") 
                _ra_via_update(divIndex+1);
        }

        function updateProgressbar(){
            if(currentFileIndex == {{lastFile}}) {
                //  Code for Progress bar
                progress_value = 'Progress: ' + (currentFileIndex + 1).toString() + ' / ' + ({{lastFile}}  + 1).toString()
                $("#prg").text(progress_value);                        
                var prog_width = ((currentFileIndex + 1)/({{lastFile}} + 1))*100
                prog_width = prog_width.toFixed(2)
                $("#progress-bar").width(prog_width.toString() + '%');
                $('#preview').text(prog_width.toString() + '%');
                // Code for Progress bar Ends

                last_previous = 1
                doneButton.removeClass('hidden-element');
                $('.toggleLooping').addClass('hidden-element');
                $('.annotationArea').addClass('hidden-element');
                $('.thanksNote').removeClass('hidden-element');

                if( "{{ experiment.category }}" === "video" || "{{ experiment.category }}" === "audio") {
                    if( "{{ experiment.uploadType }}" === "manual" ) {
                    }
                        var f = $(".file[data-index='" + currentLoadedFile + "']");
                        f.find(".clip")[0].pause();
                        // f.find(".clip")[0].removeAttribute('src');
                        // f.find(".clip")[0].load();
                }
            } 
            else {
                if( "{{ experiment.category }}" === "video" || "{{ experiment.category }}" === "audio") {
                    stopThisClip(currentLoadedFile);
                }
                currentFileIndex += 1;
                $(".file[data-index='" + currentLoadedFile + "']").addClass('hidden-element');
                currentLoadedFile = (currentLoadedFile + 1) % preLoadLimit;
                preLoadFiles();
                showCurrentFile(currentLoadedFile);

                progress_value = 'Progress: ' + (currentFileIndex).toString() + ' / ' + ({{lastFile}} + 1).toString()
                $("#prg").text(progress_value);                                                
                var prog_width = (currentFileIndex/({{lastFile}} + 1))*100
                prog_width = prog_width.toFixed(2)
                $("#progress-bar").width(prog_width.toString() + '%');
                $('#preview').text(prog_width.toString() + '%');
            }
        }

        function newFile(divIndex, fileIndex, showCurrent) {
            var url = "{{ url_for('annotate_experiment._getFileDetails')}}";
            var data = {
                'currentFileIndex' :    fileIndex,
                'experimentId' :        "{{experiment.id}}",
                'firstFile' : "{{firstFile}}",
            };

            $.getJSON(url , data, function(newFile) {
                updateFile(divIndex, newFile);
                if (showCurrent) {
                    showCurrentFile(divIndex);
                }
            });
        }

        function stopThisClip(divIndex) {
            var f = $(".file[data-index='" + divIndex + "']");
            if (f.length != 0) {
                f.find(".clip")[0].pause();
            }
        }
        
        function playThisClip(divIndex) {
            var f = $(".file[data-index='" + divIndex + "']");
            if (f.length != 0) {
                f.find(".clip")[0].play();
            }
        }

        function showCurrentFile(divIndex) {
            loadedFile = $(".file[data-index='" + divIndex + "']");
            loadedFile.removeClass('hidden-element');
            restartTimeSlider(divIndex);
            textHighlightingRestart();
            currentFileCoordinates = {}
            if( "{{ experiment.category }}" === "video" || "{{ experiment.category }}" === "audio") {
                    var clip = loadedFile.find('.clip');
                    clip[0].play();
            /*
                    clip[0].addEventListener("timeupdate", function(){
                        if (clip[0].currentTime == 0) {
                            clip[0].currentTime = clip[0].currentTime + "{{experiment.display_time.before_time}}";
                        }
                    });

            */
            }

            var fileCaption = loadedFile.find('.caption h4').text();
            $('.fileCaption h4').text(fileCaption);

            var targetFileCaption = loadedFile.find('.targetCaption h4').text();
            if("{{experiment.displayTargetCaption}}"){
                $("#targetCaptionData").val(targetFileCaption);
            }
            var fileCommentD = loadedFile.find('.fileComment h4').text();
            $("#commentsData").val(fileCommentD);

        }

        function updateFile(index, fileToLoad) {
            /*  since jquery variables can't be passed to jinja
                hence we have to use this hard coded url to
                keep dynamic filename
            */
            
            var loadedDiv = $(".file[data-index='" + index + "']");

            if( "{{ experiment.uploadType }}" === "viaSpreadsheet" ){
                var url = fileToLoad.content;
                loadedDiv.find('a').attr('href', url);
            }
            else if( "{{ experiment.uploadType }}" === "fromConcordance" ){
                if ("{{ experiment.category }}" == "image")
				{
					var url = fileToLoad.content;
				}
                else{
                    var temp_list = (fileToLoad.content).split("&");
					var temp_starttime = (temp_list[1]).split("=");
					if ("{{ experiment.display_time.before_time }}")
					{
						var before_time = parseFloat("{{ experiment.display_time.before_time }}");
					}
					else
					{
						var before_time = 0;
					}
					var starttime = parseFloat(temp_starttime[1]) - before_time;
					if (starttime < 0) {starttime = 0;}
					var temp_endtime = (temp_list[2]).split("=");
					if ("{{ experiment.display_time.after_time }}")
					{
						var after_time = parseFloat("{{ experiment.display_time.after_time }}");
					}
					else
					{
						var after_time = 0;
					}
					var endtime = parseFloat(temp_endtime[1]) + after_time;
					var url = temp_list[0] + "&start=" + starttime.toString() + "&end=" + endtime.toString();
                    if( "{{ experiment.category }}" === "video"){
                        var url_tp = fileToLoad.edge_link;
                        loadedDiv.find('a').attr('href', url_tp);
                    }
                }
            }
            else{
                var url = "/annotate_experiment/uploads/" + {{experiment.id}} + "/" + fileToLoad.content;
            }

            if( "{{ experiment.category }}" === "image") {
                loadedDiv.find('img').attr('src', url);
                loadedDiv.find('img').attr('alt', caption);
                _ra_via_update(0);
            } else if( "{{ experiment.category }}" === "video") {
                // if( "{{ experiment.uploadType }}" === "manual") {
                    var video = loadedDiv.find('.clip');
                    video.attr('src', url);
                // } else {
                //     var link = loadedDiv.find('a');
                //     link.attr('href', url);
                //     link.text(fileToLoad.name)
                // }
            } else if( "{{ experiment.category }}" === "audio") {
                // if( "{{ experiment.uploadType }}" === "manual") {
                    var audio = loadedDiv.find('.clip');
                    audio.attr('src', url);
                // } else {
                //     var link = loadedDiv.find('a');
                //     link.attr('href', url);
                //     link.text(fileToLoad.name)
                // }
            } else if( "{{ experiment.category }}" === "text") {
                loadedDiv.find('pre').text(fileToLoad.content);
            }

            var caption = fileToLoad.caption;
            var target_caption = fileToLoad.target_caption;
            var fileComment = fileToLoad.comment
            // console.log(fileComment);
            loadedDiv.find('.caption h4').text(caption);
            loadedDiv.find('.targetCaption h4').text(target_caption);
            loadedDiv.find('.fileComment h4').text(fileComment);
            loadedDiv.data("fileid", fileToLoad.id);
        }

    });

    function save_targetCaption(fileId, targetCaption){
        var url = "{{ url_for('annotate_experiment.saveTargetCaption')}}";
        var data = {
            'fileId' : fileId,
            'targetCaption': targetCaption,
        };
        $.ajax({
            url: url,
            type: 'POST',
            data: data,
        });
    };

    function save_comment(fileId, comment){
        var url = "{{ url_for('annotate_experiment.saveFileComment')}}";
        var data = {
            'fileId' : fileId,
            'comment': comment,
        };
        $.ajax({
            url: url,
            type: 'POST',
            data: data,
        });
    };

    $(document).ready(function(){
        $(".send_notification").click(function(){
            new_notification();
            $('#notify').removeClass('hidden-element').fadeIn(600).delay(1500).fadeOut(700);
            $('#msg2').text("Notification has been sent");
            var input = this;
            input.disabled = true;
        });

        function new_notification(){
            var url = "{{ url_for('notification._addNotification')}}";
            var data = {
                'experimentId' : "{{experiment.id}}",
            };
            $.ajax({
                url: url,
                type: 'POST',
                data: data,
            });
        };
    });
</script>
{% endblock annotate_experiment_body %}
